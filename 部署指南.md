# Space One 拼房实验室 - 部署指南

## 📋 部署前准备

### 1. 确认环境
- [ ] 腾讯云服务器正常运行（49.233.127.228）
- [ ] 本地微信开发者工具已安装
- [ ] 已完成测试清单中的所有测试
- [ ] Git 代码已是最新版本

### 2. 备份数据
```bash
# 登录服务器
ssh root@49.233.127.228

# 备份当前数据
cd /root/Roomie-Claude
cp room_data.json room_data_backup_$(date +%Y%m%d_%H%M%S).json

# 查看备份
ls -lh room_data_backup_*
```

---

## 🚀 部署步骤

### 第一步：部署后端 API

#### 1.1 上传最新代码
在**本地终端**运行：
```bash
cd "/Users/songsongsong/Library/Mobile Documents/com~apple~CloudDocs/同步盘/INNOVATION MAP/赵嵩项目/202601编程思维课/Roomie"

scp api_final.py root@49.233.127.228:/root/Roomie-Claude/api.py
```

#### 1.2 重启 API 服务
```bash
ssh root@49.233.127.228 "cd /root/Roomie-Claude && pkill -f 'python3 api.py' && nohup python3 api.py > api.log 2>&1 &"
```

#### 1.3 验证 API 运行
```bash
# 等待3秒让服务启动
sleep 3

# 测试健康检查
ssh root@49.233.127.228 "curl -s http://localhost:5000/api/health"
```

**预期输出**：
```json
{"status":"ok","timestamp":1234567890.123}
```

如果没有输出或报错，检查日志：
```bash
ssh root@49.233.127.228 "tail -50 /root/Roomie-Claude/api.log"
```

---

### 第二步：部署前端小程序

#### 2.1 打开微信开发者工具
1. 启动微信开发者工具
2. 打开项目：`Roomie-Claude/miniprogram`
3. 确认 AppID 正确

#### 2.2 编译测试
1. 点击工具栏的"编译"按钮
2. 检查控制台是否有错误
3. 在模拟器中快速测试主要流程：
   - 输入口令 → 填写表单 → 查看结果

#### 2.3 真机预览（重要！）
1. 点击工具栏的"预览"按钮
2. 用手机微信扫码
3. 在真机上完整测试一遍（参考测试清单）

#### 2.4 上传代码
**⚠️ 注意：只有测试通过后才执行此步骤**

1. 点击工具栏的"上传"按钮
2. 填写版本号：`1.0.0`
3. 填写项目备注：`公开发布版本：用户协议、隐私政策、错误处理优化`
4. 点击"上传"

#### 2.5 提交审核
1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入"版本管理" → "开发版本"
3. 找到刚上传的版本
4. 点击"提交审核"
5. 填写审核信息：
   - 功能页面：首页、表单页、结果页
   - 测试账号：（如果需要）
   - 补充说明：拼房信息匹配服务

---

## 🔍 部署后验证

### 1. 后端验证
```bash
# 测试健康检查
curl http://49.233.127.228:5000/api/health

# 测试口令验证
curl "http://49.233.127.228:5000/api/check_code?group_code=ASBJ0328"

# 测试统计接口
curl http://49.233.127.228:5000/api/stats
```

### 2. 前端验证
- [ ] 真机上打开小程序
- [ ] 完整走一遍用户流程
- [ ] 检查协议页面显示正常
- [ ] 检查错误提示友好

### 3. 数据验证
```bash
# 查看数据文件
ssh root@49.233.127.228 "cat /root/Roomie-Claude/room_data.json | python3 -m json.tool"

# 检查数据排序（matched 在前）
ssh root@49.233.127.228 "cat /root/Roomie-Claude/room_data.json | python3 -c \"import json,sys; data=json.load(sys.stdin); print('Total users:', len(data['users'])); print('Matched:', sum(1 for u in data['users'] if u['status']=='matched')); print('Active:', sum(1 for u in data['users'] if u['status']=='active'))\""
```

---

## 🔧 常见问题处理

### 问题1：API 无法访问
**症状**：curl 返回 "Connection refused" 或超时

**解决**：
```bash
# 检查进程
ssh root@49.233.127.228 "ps aux | grep 'python3 api.py'"

# 如果没有进程，重启
ssh root@49.233.127.228 "cd /root/Roomie-Claude && nohup python3 api.py > api.log 2>&1 &"

# 查看日志
ssh root@49.233.127.228 "tail -50 /root/Roomie-Claude/api.log"
```

### 问题2：端口被占用
**症状**：日志显示 "Port 5000 is in use"

**解决**：
```bash
# 强制杀掉占用端口的进程
ssh root@49.233.127.228 "fuser -k 5000/tcp"

# 重启服务
ssh root@49.233.127.228 "cd /root/Roomie-Claude && nohup python3 api.py > api.log 2>&1 &"
```

### 问题3：小程序编译错误
**症状**：微信开发者工具显示红色错误

**解决**：
1. 检查 app.json 中的 pages 路径是否正确
2. 检查所有页面的 .json 文件是否存在
3. 清除缓存：工具 → 清除缓存 → 清除所有
4. 重新编译

### 问题4：真机无法访问后端
**症状**：真机上显示"网络连接失败"

**解决**：
1. 检查手机网络是否正常
2. 检查服务器防火墙是否开放 5000 端口
3. 在微信开发者工具中检查"不校验合法域名"是否勾选（开发阶段）
4. 正式上线前需要在微信公众平台配置服务器域名

### 问题5：数据丢失
**症状**：用户数据不见了

**解决**：
```bash
# 恢复备份
ssh root@49.233.127.228 "cd /root/Roomie-Claude && ls -lh room_data_backup_*"

# 选择最新的备份恢复
ssh root@49.233.127.228 "cd /root/Roomie-Claude && cp room_data_backup_YYYYMMDD_HHMMSS.json room_data.json"

# 重启服务
ssh root@49.233.127.228 "cd /root/Roomie-Claude && pkill -f 'python3 api.py' && nohup python3 api.py > api.log 2>&1 &"
```

---

## 📊 监控和维护

### 日常检查（每天）
```bash
# 检查 API 是否运行
ssh root@49.233.127.228 "curl -s http://localhost:5000/api/health"

# 查看最新日志
ssh root@49.233.127.228 "tail -20 /root/Roomie-Claude/api.log"

# 查看用户数
ssh root@49.233.127.228 "cat /root/Roomie-Claude/room_data.json | python3 -c \"import json,sys; print('Total users:', len(json.load(sys.stdin)['users']))\""
```

### 定期备份（每周）
```bash
# 下载数据到本地
scp root@49.233.127.228:/root/Roomie-Claude/room_data.json ~/Desktop/room_data_backup_$(date +%Y%m%d).json

# 查看备份
ls -lh ~/Desktop/room_data_backup_*
```

### 清理旧数据（按需）
```bash
# 清空所有数据（谨慎操作！）
ssh root@49.233.127.228 "echo '{\"users\": [], \"stats\": {\"total_matches\": 0}}' > /root/Roomie-Claude/room_data.json"

# 重启服务
ssh root@49.233.127.228 "cd /root/Roomie-Claude && pkill -f 'python3 api.py' && nohup python3 api.py > api.log 2>&1 &"
```

---

## 🎯 上线后的第一周

### Day 1：发布当天
- [ ] 每2小时检查一次 API 状态
- [ ] 监控用户数增长
- [ ] 及时响应用户反馈

### Day 2-3：观察期
- [ ] 每天早晚检查 API 状态
- [ ] 查看是否有错误日志
- [ ] 收集用户反馈

### Day 4-7：稳定期
- [ ] 每天检查一次
- [ ] 分析匹配成功率
- [ ] 准备优化方案

---

## 📝 启用 OpenID 登录（正式上线时）

**时机**：内测完成，准备正式公开运营时

**步骤**：
1. 打开 `miniprogram/app.js`
2. 找到第12行：`// this.doLogin()`
3. 取消注释改为：`this.doLogin()`
4. 重新上传小程序
5. 提交审核

**验证**：
- 打开小程序，查看控制台
- 应该看到 "登录成功，openid: wx..." 的日志

---

## 🔐 安全提醒

1. **不要泄露服务器密码**
2. **定期备份数据**
3. **监控异常访问**
4. **及时更新代码**
5. **保护用户隐私**

---

## 📞 紧急联系

**如果遇到无法解决的问题**：
- 邮箱：spaceone.roomie@gmail.com
- 可以回滚到上一个版本
- 可以暂时关闭小程序服务

---

## ✅ 部署检查清单

部署完成后，确认以下所有项：

- [ ] 后端 API 正常运行
- [ ] 健康检查接口返回正常
- [ ] 小程序已上传到微信平台
- [ ] 真机测试通过
- [ ] 数据已备份
- [ ] 监控脚本已设置
- [ ] 用户协议和隐私政策显示正常
- [ ] 错误提示友好
- [ ] 所有功能测试通过

---

**部署日期**：________

**部署人员**：________

**版本号**：1.0.0

**备注**：________
